# üåæ AgroMark - Sistema Administrativo-Financeiro

**Disciplina:** ESW424 - Pr√°tica de Engenharia de Software (2025/02)  
**Professor:** Jo√£o Dionisio Paraiba  
**Aluno:** Marques Vin√≠cius Melo Martins

## üìã Sobre o Projeto

O AgroMark √© um sistema administrativo-financeiro voltado ao agroneg√≥cio. Na **Etapa 1** entregamos o fluxo de upload de notas fiscais (PDF) e extra√ß√£o estruturada via Google Gemini. A **Etapa 2** (peso 60%) adiciona persist√™ncia relacional com PostgreSQL + Prisma, verifica√ß√£o autom√°tica de cadastros e lan√ßamento de movimentos financeiros com parcelas, classifica√ß√µes e controle de status (inativar/reativar).

## üõ†Ô∏è Tecnologias Utilizadas

- **Backend:** Node.js, Express, Prisma ORM
- **Banco:** PostgreSQL (Docker/Compose)
- **Frontend:** React (CRA) + Tailwind CSS
- **IA:** Google Gemini 2.5 Flash
- **Outros:** Multer/PDF-Parse (upload NF), Helmet, CORS, Rate limiting
- **Infra Etapa 2:** Dockerfiles (backend/frontend) + docker-compose para backend, frontend e banco

## ‚ú® Funcionalidades da Etapa 2

- **Upload + Extra√ß√£o (Etapa 1 mantida):** upload do PDF, extra√ß√£o formatada/JSON via Gemini.
- **Verifica√ß√£o em Banco:** bot√£o ‚ÄúVerificar no Banco‚Äù consulta Postgres e exibe badges ‚ÄúEXISTE ‚Äî ID‚Äù ou ‚ÄúN√ÉO EXISTE‚Äù para fornecedor, faturado e classifica√ß√£o de despesa.
- **Cria√ß√£o Condicional:** bot√£o ‚ÄúCriar/Atualizar e Lan√ßar‚Äù cria cadastros faltantes, registra movimento APAGAR, parcelas e classifica√ß√µes (N:N) em transa√ß√£o Prisma.
- **Soft-delete por status:** Pessoas e classifica√ß√µes possuem `status` (ATIVO/INATIVO). Endpoints PATCH para inativar/reativar.
- **Seeds:** Classifica√ß√µes padr√£o da Etapa 1 pr√©-cadastradas.
- **Valida√ß√µes e rate limiting:** Normaliza√ß√£o/valida√ß√£o de CPF/CNPJ, retorno 400/409 adequado, prote√ß√£o em `/api/create/*` e `/api/movimentos`.
- **Dockeriza√ß√£o completa:** Containers independentes para Postgres, backend (com `prisma migrate deploy` no start) e frontend (build est√°tico via Nginx).

## üöÄ Setup Local (Desenvolvimento)

### 1. Pr√©-requisitos

- [Node.js](https://nodejs.org/) 18+
- [PostgreSQL](https://www.postgresql.org/) (local ou dentro do Docker Compose)
- [Git](https://git-scm.com/)

### 2. Instala√ß√£o

```bash
# Clone o reposit√≥rio
git clone https://github.com/marquesvinicius/agromark.git
cd agromark

# Instale depend√™ncias
npm --prefix backend install
npm --prefix frontend install
```

### 3. Configura√ß√£o do Ambiente (backend/.env)

Crie `backend/.env` com base em `backend/env.example`:

```env
NODE_ENV=development
PORT=5000

# Ajuste o host conforme sua instala√ß√£o do Postgres
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/agromark?schema=public
GEMINI_API_KEY=SUA_CHAVE_GEMINI_AQUI
MAX_FILE_SIZE=10485760
```

> **Aten√ß√£o:** a chave da Gemini **n√£o** deve ser utilizada em health-checks. O endpoint `/api/readiness-llm` √© separado, com cache e executado apenas manualmente.

### 4. Banco de Dados (modo dev)

```bash
# Gerar cliente Prisma
dnpm --prefix backend run prisma:generate

# Criar/aplicar migra√ß√µes (modo dev)
npm --prefix backend run prisma:migrate

# Inserir seeds (classifica√ß√µes de despesa)
npm --prefix backend run prisma:seed
```

### 5. Executar ambiente dev

```bash
npm --prefix backend run dev   # Backend ‚Üí http://localhost:5000
npm --prefix frontend start    # Frontend ‚Üí http://localhost:3000
```

### 6. Comandos √∫teis

- `npm --prefix backend run prisma:migrate` ‚Üí cria/aplica migra√ß√µes em dev.
- `npm --prefix backend run prisma:seed` ‚Üí executa seeds.
- `npm --prefix backend run prisma:generate` ‚Üí atualiza client ap√≥s alterar schema.
- `npm --prefix backend run prisma:deploy` ‚Üí aplica migra√ß√µes em produ√ß√£o.
- `npx prisma studio --schema backend/prisma/schema.prisma` ‚Üí abre Prisma Studio.

## üê≥ Ambiente Docker (produ√ß√£o local)

Ideal para corre√ß√£o do professor.

### Passo a passo

1. **Instale Docker Desktop:** <https://www.docker.com/products/docker-desktop/>
2. **Crie `backend/.env`:** copie `backend/env.example`, edite `GEMINI_API_KEY`.
3. **Suba os containers:**

```bash
docker compose up --build -d
```

4. **Acesse:**
   - Frontend: <http://localhost:3000>
   - Backend/API: <http://localhost:5000/api>

### Servi√ßos no compose

- `postgres`: banco com volume persistente `pgdata` e healthcheck.
- `backend`: Express + Prisma; roda `prisma migrate deploy` automaticamente no start. Inclui `app.set('trust proxy', 1)` para funcionar atr√°s do Nginx do frontend.
- `frontend`: build React servido via Nginx; proxy de todas as chamadas `/api` para o backend (Docker). O build do React recebe `REACT_APP_API_URL=/api` via ARG.

### Comandos √∫teis

- Subir: `docker compose up --build -d`
- Parar: `docker compose down`
- Parar e remover dados: `docker compose down -v`
- Ver logs: `docker compose logs -f backend`
- Prisma Studio (via container backend):
  ```bash
  docker compose exec backend npx prisma studio
  ```

### Consultar Postgres do Docker

- GUI (DBeaver/TablePlus)
  - Host: `localhost`
  - Port: `5432`
  - Database: `agromark`
  - User: `postgres`
  - Password: `postgres`
- CLI dentro do container
  ```bash
  docker compose exec postgres psql -U postgres -d agromark
  ```
  Comandos no psql: `\dt`, `SELECT COUNT(*) FROM pessoa;`, `\q`

## üß© Regras de valida√ß√£o e mensagens

- CPF/CNPJ (acad√™mico): valida√ß√£o **relaxada** (apenas quantidade de d√≠gitos) para permitir documentos gen√©ricos (ex.: `999.999.999-99`).
- Classifica√ß√£o: se n√£o vier descri√ß√£o, o backend assume `OUTROS`.
- Lan√ßamento de movimentos (`POST /api/movimentos`):
  - Bloqueio de duplicidade por NF + fornecedor ‚Üí `409 MOVIMENTO_JA_EXISTE` com mensagem amig√°vel.
  - Identifica√ß√£o de parcelas √© √∫nica. Agora utiliza padr√£o `numeroNF-<idMovimento>-parcela-XX` para evitar colis√µes hist√≥ricas.
  - Caso ainda ocorra colis√£o, o backend adiciona sufixo √∫nico de seguran√ßa.
- Exclus√£o de movimentos: `DELETE /api/movimentos/:id` remove movimento, parcelas e v√≠nculos em transa√ß√£o.

## üñ•Ô∏è UI ‚Äì A√ß√µes recentes

- P√°gina ‚ÄúMovimentos‚Äù: adicionada coluna **A√ß√µes** com bot√£o de lixeira (cores do tema) para exclus√£o. Ap√≥s excluir, a lista √© recarregada.
- P√°gina principal: fluxo ‚ÄúVerificar no Banco‚Äù ‚ûú ‚ÄúRegistrar Movimento‚Äù com toasts e mensagens do backend (inclui 409 amig√°vel quando repetido).

## ‚öôÔ∏è Notas de infraestrutura e troubleshooting

- CORS: produ√ß√£o aceita dom√≠nios `.vercel.app` e os dom√≠nios listados no `server.js`; desenvolvimento aceita `http://localhost:3000`.
- Rate limiting: health-check de plataforma foi isolado ‚Äì a rota `/api/health` fica **fora** do rate limiter global para evitar `429` em health checks.
- Proxy/Nginx (frontend Docker): todo request √† API deve ir para `/api/...`. O frontend usa `REACT_APP_API_URL` definido como `/api` no build do Docker.
- Se ver `ValidationError: The 'X-Forwarded-For' header...` habilite `app.set('trust proxy', 1)` (j√° aplicado).

## üåê Deploy (Vercel + Render)

### Frontend (Vercel)

1. Importar o reposit√≥rio e definir **Root Directory**: `frontend`.
2. Vari√°veis de ambiente:
   - `REACT_APP_API_URL`: URL p√∫blica do backend + `/api`, ex.: `https://agromark-backend.onrender.com/api`
3. Build Command/Output: deixe nos padr√µes da Vercel (CRA) ‚Äî sem override.

### Backend (Render)

1. Criar banco PostgreSQL gerenciado e copiar a **Internal Database URL**.
2. Criar Web Service do backend com Root Directory `backend` (Dockerfile detectado).
3. Vari√°veis de ambiente:
   - `DATABASE_URL` = Internal Database URL
   - `GEMINI_API_KEY`
4. Build/Deploy:
   - Build: padr√£o (usa Dockerfile do backend) e aplica `npx prisma migrate deploy` durante o start.
5. Seed (plano gratuito, sem jobs):
   - Temporariamente altere o Start Command para `npx prisma db seed && npm start`.
   - Aguarde o deploy, verifique os dados, e **retorne** o Start Command para `npm start`.

### Dicas de troubleshooting

- 404 ao chamar `/health` na Vercel: lembre-se de setar `REACT_APP_API_URL` com `/api` ao final no valor.
- 429 na Render (health): a rota `/api/health` j√° est√° fora do rate limiter.
- 405 no Docker ao fazer upload: verifique `frontend/nginx.conf` (proxy de `/api/` para o backend) e reconstru√ß√£o com `docker compose up --build`.

## üì¶ Vari√°veis de ambiente (resumo)

- Frontend (Vercel/Docker build):
  - `REACT_APP_API_URL` (Vercel: `https://.../api`, Docker: `/api` via ARG no Dockerfile do frontend)
- Backend (Render/Docker):
  - `DATABASE_URL`
  - `GEMINI_API_KEY`
  - `PORT`, `MAX_FILE_SIZE` (opcional)

## üìä Endpoints REST (Etapa 2)

Todos retornam JSON.

### Verifica√ß√£o agregada

```bash
curl -X POST http://localhost:5000/api/check/all \
  -H "Content-Type: application/json" \
  -d '{
    "fornecedor": {"cnpj":"12.345.678/0001-90","razaoSocial":"IGUA√áU MAQUINAS LTDA"},
    "faturado":   {"cpf":"999.999.999-99","nomeCompleto":"BELTRANO DA SILVA"},
    "classificacaoDespesa":"MANUTEN√á√ÉO E OPERA√á√ÉO",
    "numeroNota":"000123456","dataEmissao":"2025-01-15",
    "parcelas":[{"dataVencimento":"2025-02-15","valor":1250.00}],
    "valorTotal":1250.00,
    "itensDescricao":["√ìleo diesel"]
  }'
```

### Demais endpoints

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| POST | `/api/check/fornecedor` | Verifica fornecedor por CNPJ |
| POST | `/api/check/faturado` | Verifica faturado por CPF/CNPJ |
| POST | `/api/check/despesa` | Verifica classifica√ß√£o de despesa |
| POST | `/api/create/necessary` | Cria fornecedor/faturado/classifica√ß√£o se n√£o existirem |
| POST | `/api/movimentos` | Cria movimento, parcelas e v√≠nculos N:N (transa√ß√£o Prisma) |
| PATCH | `/api/pessoas/:id/inativar` | Marca pessoa como INATIVA |
| PATCH | `/api/pessoas/:id/reativar` | Marca pessoa como ATIVA |
| PATCH | `/api/classificacoes/:id/inativar` | Inativa classifica√ß√£o |
| PATCH | `/api/classificacoes/:id/reativar` | Reativa classifica√ß√£o |
| GET | `/api/upload/categories` | Lista classifica√ß√µes de despesa ativas |
| GET | `/api/health` | Health check leve (sem IA) |
| GET | `/api/readiness-llm` | Teste manual/cacheado da LLM |

## üß± Modelo de Dados (Prisma)

- `Pessoa`: tipos FORNECEDOR/FATURADO/CLIENTE; documento √∫nico por tipo; status ATIVO/INATIVO.
- `Classificacao`: tipos DESPESA/RECEITA; descri√ß√£o √∫nica por tipo; status.
- `MovimentoContas`: tipo APAGAR/ARECEBER (usamos APAGAR); liga√ß√£o com fornecedor/faturado; valor total; status; N:N com classifica√ß√µes.
- `ParcelaContas`: 1..N parcelas por movimento; identifica√ß√£o √∫nica (`numeroNF-parcela-NN`); controle de saldo e status da parcela.
- `MovimentoClassificacao`: tabela de jun√ß√£o (N:N) com chave composta.

Seeds inserem as classifica√ß√µes utilizadas na Etapa 1.

## üñ•Ô∏è Interface (Etapa 2)

- Layout da Etapa 1 mantido.
- Novos bot√µes:
  - **Verificar no Banco:** chama `/api/check/all` e exibe badges ‚ÄúEXISTE ‚Äî ID‚Äù ou ‚ÄúN√ÉO EXISTE‚Äù.
  - **Criar/Atualizar e Lan√ßar:** chama `/api/create/necessary` seguido de `/api/movimentos`; exibe toast verde ‚ÄúRegistro lan√ßado com sucesso (Movimento #ID)‚Äù.
- Fallbacks para campos ausentes: UI orienta revisar JSON antes de lan√ßar.

## ‚úÖ Checklist de Aceita√ß√£o

- [x] `npm run dev` continua funcional (upload + extra√ß√£o).
- [x] `/api/check/all` retorna EXISTE/N√ÉO EXISTE com IDs.
- [x] `/api/create/necessary` cria cadastros ausentes.
- [x] `/api/movimentos` registra movimento + parcelas + classifica√ß√µes em transa√ß√£o.
- [x] PATCH (inativar/reativar) funcionando.
- [x] Seeds aplicados.
- [x] Health sem IA; readiness LLM separado/cacheado.
- [x] UI mostra blocos exigidos + toast de sucesso.
- [x] `docker compose up --build` sobe Postgres + Backend + Front.

## üóÉÔ∏è Estrutura

```
agromark/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seed.js
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ movimentos.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pessoas.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ classificacoes.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documentUtils.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prismaClient.js
‚îÇ   ‚îú‚îÄ‚îÄ middleware/rateLimiter.js
‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îú‚îÄ‚îÄ server.js
‚îÇ   ‚îî‚îÄ‚îÄ env.example
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/components/ResultsDisplay.js
‚îÇ   ‚îú‚îÄ‚îÄ src/services/apiService.js
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ docs/
```

## üåê Deploy

- **Frontend (React):** Vercel ‚Üí <https://agromark-esw424.vercel.app>
- **Backend (Node.js):** Render ‚Üí <https://agromark-backend.onrender.com/api>

Configure `GEMINI_API_KEY`, `DATABASE_URL` e afins nas plataformas de deploy.

## üôå Cr√©ditos

Projeto acad√™mico de **Marques Vin√≠cius Melo Martins** para ESW424 ‚Äì Pr√°tica de Engenharia de Software.
